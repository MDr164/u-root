version: 2.1

# Needed for uploading coverage reports
orbs:
  codecov: codecov/codecov@3.2.5

templates:
  # Base environment with dagger tooling
  golang-template:
    &golang-template
    docker:
      - image: cimg/go:1.20
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build CI tool
          working_directory: tools/ci
          command: go build

  # Several tasks need more resources than what CircleCI offers by default
  beefy-template:
    &beefy-template
    <<: *golang-template
    resource_class: large

workflows:
  ci:
    jobs:
      - build
      - unit-tests
      - race
      - check_templates
      - test-integration-amd64
      - test-integration-arm32
      - test-integration-arm64
      - test-tinygo

jobs:
  # This build for all supported architecture and platform combinations
  build:
    <<: *golang-template
    steps:
      - run:
          name: Test u-root build
          command: ./tools/ci/ci -verbose -build
            -target=all
            -buildtoolchain="std,tamago,tinygo"
            -arch="amd64,arm,arm64,riscv64"
            -platform=linux
          no_output_timeout: 15m

  # Run all unit tests and generate a coverage report
  unit-tests:
    <<: *beefy-template
    steps:
      - run:
          name: Run unit tests
          command: ./tools/ci/ci -verbose -test
            -cover
          no_output_timeout: 15m
      - codecov/upload:
          file: coverage.txt

  # Run Golangs race condition detector
  race:
    <<: *beefy-template
    steps:
      - run:
          name: Race condition detection
          command: ./tools/ci/ci -verbose -test
            -race
          no_output_timeout: 15m

  check_templates:
    <<: *golang-template
    steps:
      - checkout
      - run:
          name: Check all build templates
          command: ./tools/ci/ci -verbose -build
            -target=templates
            -arch="amd64,arm,arm64"
            -platform=linux
          no_output_timeout: 15m
      - store_artifacts:
          name: Store build stats
          path: /tmp/stats.json
          destination: stats.json

  test-integration-amd64:
    <<: *beefy-template
    steps:
      - run:
          name: Run integration tests
          command: ./tools/ci/ci -verbose -test
            -integration=amd64
            -env="UROOT_QEMU_TIMEOUT_X=7"
          no_output_timeout: 15m

  test-integration-arm32:
    <<: *beefy-template
    steps:
      - run:
          name: Run integration tests
          command: ./tools/ci/ci -verbose -test
            -integration=arm32
            -env="UROOT_QEMU_TIMEOUT_X=7"
          no_output_timeout: 15m

  test-integration-arm64:
    <<: *beefy-template
    steps:
      - run:
          name: Run integration tests
          command: ./tools/ci/ci -verbose -test
            -integration=arm64
            -env="UROOT_QEMU_TIMEOUT_X=7"
          no_output_timeout: 15m

  test-tinygo:
    <<: *beefy-template
    steps:
      - checkout
      - run:
          name: Run unit tests with TinyGo
          command: ./tools/ci/ci -verbose -test
            -testtoolchain="tinygo"
          no_output_timeout: 15m
